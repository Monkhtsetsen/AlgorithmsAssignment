<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>OSM Path Finder - –£–ª–∞–∞–Ω–±–∞–∞—Ç–∞—Ä</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <style>
        html, body, #map { height: 100%; margin: 0; padding: 0; }
        .panel {
            position: absolute; top: 10px; left: 10px;
            background: rgba(255,255,255,0.95);
            padding: 15px; border-radius: 10px;
            font-family: Arial; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 300px;
        }
        button {
            margin: 4px; padding: 8px 12px; border: none; border-radius: 6px;
            cursor: pointer; font-weight: bold; width: 100%;
        }
        .dijkstra { background: #ff6b6b; color: white; }
        .bfs { background: #4dabf7; color: white; }
        .dfs { background: #51cf66; color: white; }
        .reset { background: #ffc107; color: black; }
        #infoBox {
            font-size: 13px; margin-top: 10px; background: #f8f9fa;
            padding: 8px; border-radius: 6px; border-left: 4px solid #28a745;
        }
        .algorithm-info {
            font-size: 11px; color: #666; margin-top: 3px;
        }
        .stats {
            background: #e9ecef; padding: 6px; border-radius: 4px;
            margin-top: 8px; font-size: 12px;
        }
    </style>
</head>
<body>
<div id="map"></div>

<div class="panel">
    <b>–£–ª–∞–∞–Ω–±–∞–∞—Ç–∞—Ä - –ó–∞–º –¢”©–ª”©–≤–ª”©–≥”©”©</b><br>
    <small>–ê–ª–≥–æ—Ä–∏—Ç–º —Å–æ–Ω–≥–æ–æ–¥, 2 —Ü—ç–≥ –¥–∞—Ä–Ω–∞ —É—É</small>

    <button class="dijkstra" onclick="runAlgo('dijkstra')">
        Dijkstra - –•–∞–º–≥–∏–π–Ω –±–æ–≥–∏–Ω–æ –∑–∞–º
        <div class="algorithm-info">(–ó–∞–π–≥ —Ö–∞—Ä–≥–∞–ª–∑—Å–∞–Ω)</div>
    </button>

    <button class="bfs" onclick="runAlgo('bfs')">
        BFS - –•–∞–º–≥–∏–π–Ω —Ü”©”©–Ω –∞–ª—Ö–∞–º
        <div class="algorithm-info">(–ê–ª—Ö–∞–º—ã–Ω —Ç–æ–æ–≥ –±–∞–≥–∞—Å–≥–∞—Å–∞–Ω)</div>
    </button>

    <button class="dfs" onclick="runAlgo('dfs')">
        üü¢ DFS - –ì“Ø–Ω —Ä“Ø“Ø —á–∏–≥–ª—ç—Å—ç–Ω —Ö–∞–π–ª—Ç
        <div class="algorithm-info">(–ë–æ–ª–æ–º–∂–∏—Ç –∑–∞–º—É—É–¥)</div>
    </button>

    <button class="reset" onclick="resetMap()">–¶—ç–≤—ç—Ä–ª—ç—Ö</button>

    <div class="stats" id="stats">
        –ì—Ä–∞—Ñ: ...<br>
        –°“Ø“Ø–ª–∏–π–Ω “Ø—Ä –¥“Ø–Ω: -
    </div>

    <div id="infoBox">
        –≠—Ö–ª—ç–ª –±–∞ —Ç”©–≥—Å–≥”©–ª —Ü—ç–≥–∏–π–≥ –¥–∞—Ä–∂ —Å–æ–Ω–≥–æ–Ω–æ —É—É.
    </div>
</div>

<script>
let map = L.map('map').setView([47.918, 106.917], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
}).addTo(map);

let startMarker = null, endMarker = null, routeLine = null;
let startCoords = null, endCoords = null;

// Load graph info on startup
fetch('/api/graph_info')
    .then(r => r.json())
    .then(data => {
        document.getElementById('stats').innerHTML =
            `–ì—Ä–∞—Ñ: ${data.nodes} —Ü—ç–≥, ${data.edges} –∑–∞–º<br>–°“Ø“Ø–ª–∏–π–Ω “Ø—Ä –¥“Ø–Ω: -`;
    });

map.on('click', (e) => {
    if (!startMarker) {
        startCoords = e.latlng;
        startMarker = L.marker(e.latlng, {
            icon: L.icon({
                iconUrl: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup("–≠—Ö–ª—ç–ª").openPopup();
        info("üü¢ –≠—Ö–ª—ç–ª —Ü—ç–≥ —Å–æ–Ω–≥–æ–≥–¥–ª–æ–æ. –¢”©–≥—Å–≥”©–ª–∏–π–Ω —Ü—ç–≥—ç—ç —Å–æ–Ω–≥–æ–Ω–æ —É—É.");
    } else if (!endMarker) {
        endCoords = e.latlng;
        endMarker = L.marker(e.latlng, {
            icon: L.icon({
                iconUrl: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
                iconSize: [32, 32],
                iconAnchor: [16, 32]
            })
        }).addTo(map).bindPopup("üèÅ –¢”©–≥—Å–≥”©–ª").openPopup();
        info("–¢”©–≥—Å–≥”©–ª —Å–æ–Ω–≥–æ–≥–¥–ª–æ–æ. –ê–ª–≥–æ—Ä–∏—Ç–º —Å–æ–Ω–≥–æ–Ω–æ —É—É!");
    } else {
        alert("–•–æ—ë—Ä —Ü—ç–≥ –∞–ª—å —Ö—ç–¥–∏–π–Ω —Å–æ–Ω–≥–æ–≥–¥—Å–æ–Ω! Reset —Ö–∏–π–Ω—ç “Ø“Ø.");
    }
});

async function runAlgo(algo) {
    if (!startCoords || !endCoords) {
        alert("–≠—Ö–ª—ç–ª –±–∞ —Ç”©–≥—Å–≥”©–ª–∏–π–Ω —Ü—ç–≥–∏–π–≥ —Å–æ–Ω–≥–æ–Ω–æ —É—É!");
        return;
    }

    info("–ó–∞–º —Ç–æ–æ—Ü–æ–∂ –±–∞–π–Ω–∞...");

    try {
        const res = await fetch("/api/path", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                start_lat: startCoords.lat,
                start_lon: startCoords.lng,
                end_lat: endCoords.lat,
                end_lon: endCoords.lng,
                algorithm: algo
            })
        });

        const data = await res.json();

        if (!data.success) {
            alert("–ê–ª–¥–∞–∞: " + data.error);
            info( data.error);
            return;
        }

        // Remove old route
        if (routeLine) map.removeLayer(routeLine);

        // Draw new route
        const color = algo === "dijkstra" ? "red" : algo === "bfs" ? "blue" : "green";
        routeLine = L.polyline(data.path, {
            color: color,
            weight: 6,
            opacity: 0.8,
            lineJoin: 'round'
        }).addTo(map);

        // Fit map to route bounds
        map.fitBounds(routeLine.getBounds());

        // Update info
        const algoNames = {
            'dijkstra': 'Dijkstra',
            'bfs': 'BFS',
            'dfs': 'DFS'
        };

        info(`${algoNames[algo]} –∑–∞–º –æ–ª–¥–ª–æ–æ<br>
              –ó–∞–π: ${data.distance.toFixed(1)} –º<br>
              –•—É–≥–∞—Ü–∞–∞: ${data.time} —Å–µ–∫<br>
              –¶—ç–≥: ${data.nodes_visited} —à–∏—Ä—Ö—ç–≥`);

        document.getElementById('stats').innerHTML =
            `–ì—Ä–∞—Ñ: ...<br>–°“Ø“Ø–ª–∏–π–Ω “Ø—Ä –¥“Ø–Ω: ${algoNames[algo]} - ${data.distance.toFixed(0)}–º`;

    } catch (error) {
        console.error("Error:", error);
        alert("–°–µ—Ä–≤–µ—Ä—Ç —Ö–æ–ª–±–æ–≥–¥–æ—Ö–æ–¥ –∞–ª–¥–∞–∞ –≥–∞—Ä–ª–∞–∞");
        info(" –•–æ–ª–±–æ–ª—Ç—ã–Ω –∞–ª–¥–∞–∞");
    }
}

function resetMap() {
    if (startMarker) map.removeLayer(startMarker);
    if (endMarker) map.removeLayer(endMarker);
    if (routeLine) map.removeLayer(routeLine);

    startMarker = endMarker = routeLine = null;
    startCoords = endCoords = null;

    info(" –≠—Ö–ª—ç–ª –±–∞ —Ç”©–≥—Å–≥”©–ª —Ü—ç–≥–∏–π–≥ –¥–∞—Ö–∏–Ω —Å–æ–Ω–≥–æ–Ω–æ —É—É.");
}

function info(text) {
    document.getElementById("infoBox").innerHTML = text;
}
</script>
</body>
</html>